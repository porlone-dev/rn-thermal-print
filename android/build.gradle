apply plugin: 'com.android.library'
apply plugin: 'kotlin-android'

def isNewArchitectureEnabled() {
    return project.hasProperty("newArchEnabled") && project.newArchEnabled == "true"
}

def getJavaVersion() {
    // Try to get Java version from root project, default to 17 for modern RN (0.73+)
    def javaVersion = project.findProperty("javaVersion") ?: "17"
    return javaVersion == "11" ? JavaVersion.VERSION_11 : JavaVersion.VERSION_17
}

def reactNativeArchitectures() {
    def value = project.getProperties().get("reactNativeArchitectures")
    return value ? value.split(",") : ["armeabi-v7a", "x86", "x86_64", "arm64-v8a"]
}

android {
    compileSdkVersion = 34
    buildToolsVersion = "34.0.0"
    ndkVersion = "23.1.7779620"

    defaultConfig {
        minSdkVersion 21
        targetSdkVersion 34
        versionCode 1
        versionName "2.0.0"

        testInstrumentationRunner 'androidx.test.runner.AndroidJUnitRunner'
        
        buildConfigField "boolean", "IS_NEW_ARCHITECTURE_ENABLED", isNewArchitectureEnabled().toString()
        buildConfigField "boolean", "REACT_NATIVE_UNSTABLE_USE_RUNTIME_SCHEDULER_ALWAYS", (findProperty("reactNativeArchitectures") ?: "false").toString()
    }
    
    buildFeatures {
        prefab true
        buildConfig true
    }
    
    buildTypes {
        release {
            minifyEnabled false
            proguardFiles getDefaultProguardFile('proguard-android.txt'), 'proguard-rules.pro'
        }
    }
    
    compileOptions {
        // Support both Java 11 (RN < 0.73) and Java 17 (RN >= 0.73)
        def javaVersion = getJavaVersion()
        sourceCompatibility javaVersion
        targetCompatibility javaVersion
    }
    
    kotlinOptions {
        // Match JVM target with Java version
        jvmTarget = getJavaVersion() == JavaVersion.VERSION_11 ? "11" : "17"
    }
    
    packagingOptions {
        pickFirst 'lib/x86/libc++_shared.so'
        pickFirst 'lib/x86_64/libc++_shared.so'
        pickFirst 'lib/armeabi-v7a/libc++_shared.so'
        pickFirst 'lib/arm64-v8a/libc++_shared.so'
    }
}

repositories {
    mavenCentral()
    google()
}

dependencies {
    implementation fileTree(dir: 'libs', include: ['*.jar'])
    implementation "org.jetbrains.kotlin:kotlin-stdlib:$kotlin_version"
    implementation 'androidx.appcompat:appcompat:1.6.1'
    implementation "com.facebook.react:react-native:+"
    
    testImplementation 'junit:junit:4.13.2'
    androidTestImplementation 'androidx.test.espresso:espresso-core:3.5.1'
    
    if (isNewArchitectureEnabled()) {
        implementation "com.facebook.react:react-native:+"
    }
}
